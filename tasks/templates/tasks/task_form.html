{% extends "dashboard/base_dashboard.html" %}

{% block title %}{{ title }} - CloudTask{% endblock %}

{% block content %}
<div class="max-w-2xl mx-auto">
    <!-- Page Header -->
    <div class="mb-6">
        <a href="{% url 'tasks:list' %}" class="inline-flex items-center text-sm text-gray-500 hover:text-gray-700 mb-2">
            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
            </svg>
            Back to Tasks
        </a>
        <h1 class="text-2xl font-bold text-gray-900">{{ title }}</h1>
    </div>

    <!-- Form Card -->
    <div class="bg-white shadow rounded-lg">
        <form method="POST" enctype="multipart/form-data" class="p-6 space-y-6">
            {% csrf_token %}

            <!-- Form Errors -->
            {% if form.non_field_errors %}
            <div class="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg">
                {{ form.non_field_errors }}
            </div>
            {% endif %}

            <!-- Project (hidden if pre-selected) -->
            {% if form.project.is_hidden %}
            {{ form.project }}
            {% else %}
            <div>
                <label for="id_project" class="block text-sm font-medium text-gray-700 mb-1">
                    Project <span class="text-red-500">*</span>
                </label>
                <select name="project" id="id_project" required
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                    <option value="">-- Select Project --</option>
                    {% for project in form.project.field.queryset %}
                    <option value="{{ project.pk }}" {% if form.project.value|stringformat:"s" == project.pk|stringformat:"s" %}selected{% endif %}>
                        {{ project.name }}
                    </option>
                    {% endfor %}
                </select>
                {% if form.project.errors %}
                <p class="mt-1 text-sm text-red-600">{{ form.project.errors.0 }}</p>
                {% endif %}
            </div>
            {% endif %}

            <!-- Task Title -->
            <div>
                <label for="id_title" class="block text-sm font-medium text-gray-700 mb-1">
                    Task Title <span class="text-red-500">*</span>
                </label>
                <input type="text" name="title" id="id_title" required
                    value="{{ form.title.value|default:'' }}"
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                    placeholder="Enter task title">
                {% if form.title.errors %}
                <p class="mt-1 text-sm text-red-600">{{ form.title.errors.0 }}</p>
                {% endif %}
            </div>

            <!-- Description -->
            <div>
                <label for="id_description" class="block text-sm font-medium text-gray-700 mb-1">
                    Description
                </label>
                <textarea name="description" id="id_description" rows="4"
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                    placeholder="Describe the task">{{ form.description.value|default:'' }}</textarea>
                {% if form.description.errors %}
                <p class="mt-1 text-sm text-red-600">{{ form.description.errors.0 }}</p>
                {% endif %}
            </div>

            <!-- Assigned To -->
            <div>
                <label for="id_assigned_to" class="block text-sm font-medium text-gray-700 mb-1">
                    Assign To
                </label>
                <select name="assigned_to" id="id_assigned_to"
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                    <option value="">-- Unassigned --</option>
                    {% for user in form.assigned_to.field.queryset %}
                    <option value="{{ user.pk }}" {% if form.assigned_to.value|stringformat:"s" == user.pk|stringformat:"s" %}selected{% endif %}>
                        {{ user.get_full_name|default:user.username }}
                    </option>
                    {% endfor %}
                </select>
                {% if form.assigned_to.errors %}
                <p class="mt-1 text-sm text-red-600">{{ form.assigned_to.errors.0 }}</p>
                {% endif %}
            </div>

            <!-- Status and Priority -->
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div>
                    <label for="id_status" class="block text-sm font-medium text-gray-700 mb-1">
                        Status
                    </label>
                    <select name="status" id="id_status"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                        {% for value, label in form.status.field.choices %}
                        <option value="{{ value }}" {% if form.status.value == value %}selected{% endif %}>
                            {{ label }}
                        </option>
                        {% endfor %}
                    </select>
                    {% if form.status.errors %}
                    <p class="mt-1 text-sm text-red-600">{{ form.status.errors.0 }}</p>
                    {% endif %}
                </div>
                <div>
                    <label for="id_priority" class="block text-sm font-medium text-gray-700 mb-1">
                        Priority
                    </label>
                    <select name="priority" id="id_priority"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                        {% for value, label in form.priority.field.choices %}
                        <option value="{{ value }}" {% if form.priority.value == value %}selected{% endif %}>
                            {{ label }}
                        </option>
                        {% endfor %}
                    </select>
                    {% if form.priority.errors %}
                    <p class="mt-1 text-sm text-red-600">{{ form.priority.errors.0 }}</p>
                    {% endif %}
                </div>
            </div>

            <!-- Due Date -->
            <div>
                <label for="id_due_date" class="block text-sm font-medium text-gray-700 mb-1">
                    Due Date
                </label>
                <input type="date" name="due_date" id="id_due_date"
                    value="{{ form.due_date.value|date:'Y-m-d'|default:'' }}"
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                {% if form.due_date.errors %}
                <p class="mt-1 text-sm text-red-600">{{ form.due_date.errors.0 }}</p>
                {% endif %}
            </div>

            <!-- File Attachments -->
            <div>
                <label for="id_attachments" class="block text-sm font-medium text-gray-700 mb-1">
                    Attachments
                </label>
                <div class="mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-gray-300 border-dashed rounded-lg">
                    <div class="space-y-1 text-center">
                        <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48">
                            <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                        </svg>
                        <div class="flex text-sm text-gray-600">
                            <label for="id_attachments" class="relative cursor-pointer bg-white rounded-md font-medium text-indigo-600 hover:text-indigo-500 focus-within:outline-none focus-within:ring-2 focus-within:ring-offset-2 focus-within:ring-indigo-500">
                                <span>Upload files</span>
                                <input id="id_attachments" name="attachments" type="file" class="sr-only" multiple>
                            </label>
                            <p class="pl-1">or drag and drop</p>
                        </div>
                        <p class="text-xs text-gray-500">Any file up to 10MB each</p>
                    </div>
                </div>
                <div id="file-list" class="mt-2 space-y-1"></div>
            </div>

            <!-- Submit Buttons -->
            <div class="flex items-center justify-end space-x-3 pt-4 border-t border-gray-200">
                <a href="{% url 'tasks:list' %}"
                    class="px-4 py-2 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                    Cancel
                </a>
                <button type="submit"
                    class="px-4 py-2 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                    {{ button_text }}
                </button>
            </div>
        </form>
    </div>
</div>

<script>
// Show selected files
document.getElementById('id_attachments').addEventListener('change', function(e) {
    const fileList = document.getElementById('file-list');
    fileList.innerHTML = '';
    
    for (const file of this.files) {
        const div = document.createElement('div');
        div.className = 'flex items-center text-sm text-gray-600';
        div.innerHTML = `
            <svg class="w-4 h-4 mr-2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"/>
            </svg>
            <span>${file.name}</span>
            <span class="ml-2 text-gray-400">(${(file.size / 1024 / 1024).toFixed(2)} MB)</span>
        `;
        fileList.appendChild(div);
    }
});
</script>
{% endblock %}
