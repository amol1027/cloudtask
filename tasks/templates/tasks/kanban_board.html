{% extends "dashboard/base_dashboard.html" %}

{% block title %}Kanban Board - CloudTask{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Page Header -->
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
        <div>
            <h1 class="text-2xl font-bold text-gray-900">Kanban Board</h1>
            <p class="text-sm text-gray-500 mt-1">Drag and drop tasks to update status</p>
        </div>
        <div class="flex items-center gap-3">
            <!-- Project Filter -->
            <select id="project-filter" onchange="filterByProject(this.value)"
                class="px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500">
                <option value="">All Projects</option>
                {% for project in projects %}
                <option value="{{ project.pk }}" {% if selected_project == project.pk|stringformat:"s" %}selected{% endif %}>
                    {{ project.name }}
                </option>
                {% endfor %}
            </select>
            
            <!-- View Toggle -->
            <a href="{% url 'tasks:list' %}"
                class="inline-flex items-center px-3 py-2 border border-gray-300 text-sm font-medium rounded-lg text-gray-700 bg-white hover:bg-gray-50">
                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16"/>
                </svg>
                List View
            </a>
            
            {% if is_manager %}
            <a href="{% url 'tasks:create' %}"
                class="inline-flex items-center px-4 py-2 bg-indigo-600 text-white text-sm font-medium rounded-lg hover:bg-indigo-700">
                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                </svg>
                New Task
            </a>
            {% endif %}
        </div>
    </div>

    <!-- Kanban Board -->
    <div class="flex gap-4 overflow-x-auto pb-4" style="min-height: calc(100vh - 250px);">
        <!-- TODO Column -->
        <div class="flex-shrink-0 w-80">
            <div class="bg-gray-100 rounded-lg p-3">
                <div class="flex items-center justify-between mb-3">
                    <h3 class="font-semibold text-gray-700 flex items-center">
                        <span class="w-3 h-3 bg-gray-400 rounded-full mr-2"></span>
                        To Do
                    </h3>
                    <span class="bg-gray-200 text-gray-600 text-xs font-medium px-2 py-1 rounded-full">
                        {{ columns.TODO|length }}
                    </span>
                </div>
                <div class="kanban-column space-y-3 min-h-96" data-status="TODO" ondrop="drop(event)" ondragover="allowDrop(event)">
                    {% for task in columns.TODO %}
                    <div class="kanban-card bg-white rounded-lg shadow-sm p-4 cursor-grab active:cursor-grabbing border border-gray-200 hover:shadow-md transition-shadow"
                        draggable="true" ondragstart="drag(event)" data-task-id="{{ task.pk }}">
                        <div class="flex items-start justify-between mb-2">
                            <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium
                                {% if task.priority == 'URGENT' %}bg-red-100 text-red-800
                                {% elif task.priority == 'HIGH' %}bg-orange-100 text-orange-800
                                {% elif task.priority == 'MEDIUM' %}bg-blue-100 text-blue-800
                                {% else %}bg-gray-100 text-gray-800{% endif %}">
                                {{ task.get_priority_display }}
                            </span>
                            {% if task.is_blocked %}
                            <span class="text-yellow-500" title="Blocked by dependencies">
                                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z" clip-rule="evenodd"/>
                                </svg>
                            </span>
                            {% endif %}
                        </div>
                        <a href="{% url 'tasks:detail' task.pk %}" class="block">
                            <h4 class="font-medium text-gray-900 hover:text-indigo-600">{{ task.title }}</h4>
                        </a>
                        <p class="text-xs text-gray-500 mt-1">{{ task.project.name }}</p>
                        <div class="flex items-center justify-between mt-3">
                            {% if task.assigned_to %}
                            <div class="flex items-center">
                                <div class="w-6 h-6 rounded-full bg-indigo-100 flex items-center justify-center text-indigo-600 text-xs font-medium">
                                    {{ task.assigned_to.first_name|make_list|first|upper|default:task.assigned_to.username|make_list|first|upper }}
                                </div>
                                <span class="ml-2 text-xs text-gray-500">{{ task.assigned_to.first_name|default:task.assigned_to.username }}</span>
                            </div>
                            {% else %}
                            <span class="text-xs text-gray-400">Unassigned</span>
                            {% endif %}
                            {% if task.due_date %}
                            <span class="text-xs {% if task.due_date < today %}text-red-500{% else %}text-gray-500{% endif %}">
                                {{ task.due_date|date:"M d" }}
                            </span>
                            {% endif %}
                        </div>
                    </div>
                    {% empty %}
                    <div class="text-center py-8 text-gray-400 text-sm">No tasks</div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- IN PROGRESS Column -->
        <div class="flex-shrink-0 w-80">
            <div class="bg-blue-50 rounded-lg p-3">
                <div class="flex items-center justify-between mb-3">
                    <h3 class="font-semibold text-gray-700 flex items-center">
                        <span class="w-3 h-3 bg-blue-400 rounded-full mr-2"></span>
                        In Progress
                    </h3>
                    <span class="bg-blue-100 text-blue-600 text-xs font-medium px-2 py-1 rounded-full">
                        {{ columns.IN_PROGRESS|length }}
                    </span>
                </div>
                <div class="kanban-column space-y-3 min-h-96" data-status="IN_PROGRESS" ondrop="drop(event)" ondragover="allowDrop(event)">
                    {% for task in columns.IN_PROGRESS %}
                    <div class="kanban-card bg-white rounded-lg shadow-sm p-4 cursor-grab active:cursor-grabbing border border-blue-200 hover:shadow-md transition-shadow"
                        draggable="true" ondragstart="drag(event)" data-task-id="{{ task.pk }}">
                        <div class="flex items-start justify-between mb-2">
                            <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium
                                {% if task.priority == 'URGENT' %}bg-red-100 text-red-800
                                {% elif task.priority == 'HIGH' %}bg-orange-100 text-orange-800
                                {% elif task.priority == 'MEDIUM' %}bg-blue-100 text-blue-800
                                {% else %}bg-gray-100 text-gray-800{% endif %}">
                                {{ task.get_priority_display }}
                            </span>
                        </div>
                        <a href="{% url 'tasks:detail' task.pk %}" class="block">
                            <h4 class="font-medium text-gray-900 hover:text-indigo-600">{{ task.title }}</h4>
                        </a>
                        <p class="text-xs text-gray-500 mt-1">{{ task.project.name }}</p>
                        <div class="flex items-center justify-between mt-3">
                            {% if task.assigned_to %}
                            <div class="flex items-center">
                                <div class="w-6 h-6 rounded-full bg-indigo-100 flex items-center justify-center text-indigo-600 text-xs font-medium">
                                    {{ task.assigned_to.first_name|make_list|first|upper|default:task.assigned_to.username|make_list|first|upper }}
                                </div>
                                <span class="ml-2 text-xs text-gray-500">{{ task.assigned_to.first_name|default:task.assigned_to.username }}</span>
                            </div>
                            {% else %}
                            <span class="text-xs text-gray-400">Unassigned</span>
                            {% endif %}
                            {% if task.due_date %}
                            <span class="text-xs {% if task.due_date < today %}text-red-500{% else %}text-gray-500{% endif %}">
                                {{ task.due_date|date:"M d" }}
                            </span>
                            {% endif %}
                        </div>
                    </div>
                    {% empty %}
                    <div class="text-center py-8 text-gray-400 text-sm">No tasks</div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- IN REVIEW Column -->
        <div class="flex-shrink-0 w-80">
            <div class="bg-yellow-50 rounded-lg p-3">
                <div class="flex items-center justify-between mb-3">
                    <h3 class="font-semibold text-gray-700 flex items-center">
                        <span class="w-3 h-3 bg-yellow-400 rounded-full mr-2"></span>
                        In Review
                    </h3>
                    <span class="bg-yellow-100 text-yellow-600 text-xs font-medium px-2 py-1 rounded-full">
                        {{ columns.IN_REVIEW|length }}
                    </span>
                </div>
                <div class="kanban-column space-y-3 min-h-96" data-status="IN_REVIEW" ondrop="drop(event)" ondragover="allowDrop(event)">
                    {% for task in columns.IN_REVIEW %}
                    <div class="kanban-card bg-white rounded-lg shadow-sm p-4 cursor-grab active:cursor-grabbing border border-yellow-200 hover:shadow-md transition-shadow"
                        draggable="true" ondragstart="drag(event)" data-task-id="{{ task.pk }}">
                        <div class="flex items-start justify-between mb-2">
                            <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium
                                {% if task.priority == 'URGENT' %}bg-red-100 text-red-800
                                {% elif task.priority == 'HIGH' %}bg-orange-100 text-orange-800
                                {% elif task.priority == 'MEDIUM' %}bg-blue-100 text-blue-800
                                {% else %}bg-gray-100 text-gray-800{% endif %}">
                                {{ task.get_priority_display }}
                            </span>
                        </div>
                        <a href="{% url 'tasks:detail' task.pk %}" class="block">
                            <h4 class="font-medium text-gray-900 hover:text-indigo-600">{{ task.title }}</h4>
                        </a>
                        <p class="text-xs text-gray-500 mt-1">{{ task.project.name }}</p>
                        <div class="flex items-center justify-between mt-3">
                            {% if task.assigned_to %}
                            <div class="flex items-center">
                                <div class="w-6 h-6 rounded-full bg-indigo-100 flex items-center justify-center text-indigo-600 text-xs font-medium">
                                    {{ task.assigned_to.first_name|make_list|first|upper|default:task.assigned_to.username|make_list|first|upper }}
                                </div>
                                <span class="ml-2 text-xs text-gray-500">{{ task.assigned_to.first_name|default:task.assigned_to.username }}</span>
                            </div>
                            {% else %}
                            <span class="text-xs text-gray-400">Unassigned</span>
                            {% endif %}
                            {% if task.due_date %}
                            <span class="text-xs {% if task.due_date < today %}text-red-500{% else %}text-gray-500{% endif %}">
                                {{ task.due_date|date:"M d" }}
                            </span>
                            {% endif %}
                        </div>
                    </div>
                    {% empty %}
                    <div class="text-center py-8 text-gray-400 text-sm">No tasks</div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- DONE Column -->
        <div class="flex-shrink-0 w-80">
            <div class="bg-green-50 rounded-lg p-3">
                <div class="flex items-center justify-between mb-3">
                    <h3 class="font-semibold text-gray-700 flex items-center">
                        <span class="w-3 h-3 bg-green-400 rounded-full mr-2"></span>
                        Done
                    </h3>
                    <span class="bg-green-100 text-green-600 text-xs font-medium px-2 py-1 rounded-full">
                        {{ columns.DONE|length }}
                    </span>
                </div>
                <div class="kanban-column space-y-3 min-h-96" data-status="DONE" ondrop="drop(event)" ondragover="allowDrop(event)">
                    {% for task in columns.DONE %}
                    <div class="kanban-card bg-white rounded-lg shadow-sm p-4 cursor-grab active:cursor-grabbing border border-green-200 hover:shadow-md transition-shadow opacity-75"
                        draggable="true" ondragstart="drag(event)" data-task-id="{{ task.pk }}">
                        <div class="flex items-start justify-between mb-2">
                            <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-green-100 text-green-800">
                                âœ“ Complete
                            </span>
                        </div>
                        <a href="{% url 'tasks:detail' task.pk %}" class="block">
                            <h4 class="font-medium text-gray-900 hover:text-indigo-600 line-through">{{ task.title }}</h4>
                        </a>
                        <p class="text-xs text-gray-500 mt-1">{{ task.project.name }}</p>
                        <div class="flex items-center justify-between mt-3">
                            {% if task.assigned_to %}
                            <div class="flex items-center">
                                <div class="w-6 h-6 rounded-full bg-indigo-100 flex items-center justify-center text-indigo-600 text-xs font-medium">
                                    {{ task.assigned_to.first_name|make_list|first|upper|default:task.assigned_to.username|make_list|first|upper }}
                                </div>
                                <span class="ml-2 text-xs text-gray-500">{{ task.assigned_to.first_name|default:task.assigned_to.username }}</span>
                            </div>
                            {% else %}
                            <span class="text-xs text-gray-400">Unassigned</span>
                            {% endif %}
                        </div>
                    </div>
                    {% empty %}
                    <div class="text-center py-8 text-gray-400 text-sm">No tasks</div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// CSRF token for AJAX
const csrfToken = '{{ csrf_token }}';

function allowDrop(ev) {
    ev.preventDefault();
    ev.currentTarget.classList.add('bg-indigo-50');
}

function drag(ev) {
    ev.dataTransfer.setData("taskId", ev.target.dataset.taskId);
    ev.target.classList.add('opacity-50');
}

function drop(ev) {
    ev.preventDefault();
    ev.currentTarget.classList.remove('bg-indigo-50');
    
    const taskId = ev.dataTransfer.getData("taskId");
    const newStatus = ev.currentTarget.dataset.status;
    const card = document.querySelector(`[data-task-id="${taskId}"]`);
    
    if (card) {
        card.classList.remove('opacity-50');
        
        // Send AJAX request to update status
        fetch('{% url "tasks:update_status_ajax" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken,
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify({
                task_id: taskId,
                status: newStatus
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Move card to new column
                ev.currentTarget.appendChild(card);
                
                // Update card styling based on new status
                updateCardStyling(card, newStatus);
                
                // Update column counts
                updateColumnCounts();
            } else {
                alert(data.error || 'Failed to update task status');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to update task status');
        });
    }
}

function updateCardStyling(card, status) {
    // Remove old border colors
    card.classList.remove('border-gray-200', 'border-blue-200', 'border-yellow-200', 'border-green-200');
    card.classList.remove('opacity-75');
    
    // Add new border color and styling
    switch(status) {
        case 'TODO':
            card.classList.add('border-gray-200');
            break;
        case 'IN_PROGRESS':
            card.classList.add('border-blue-200');
            break;
        case 'IN_REVIEW':
            card.classList.add('border-yellow-200');
            break;
        case 'DONE':
            card.classList.add('border-green-200', 'opacity-75');
            break;
    }
}

function updateColumnCounts() {
    document.querySelectorAll('.kanban-column').forEach(column => {
        const count = column.querySelectorAll('.kanban-card').length;
        const header = column.parentElement.querySelector('span:last-of-type');
        if (header) {
            header.textContent = count;
        }
    });
}

function filterByProject(projectId) {
    const url = new URL(window.location);
    if (projectId) {
        url.searchParams.set('project', projectId);
    } else {
        url.searchParams.delete('project');
    }
    window.location = url;
}

// Remove highlight when drag leaves
document.querySelectorAll('.kanban-column').forEach(column => {
    column.addEventListener('dragleave', function(e) {
        this.classList.remove('bg-indigo-50');
    });
});

// Remove opacity when drag ends
document.querySelectorAll('.kanban-card').forEach(card => {
    card.addEventListener('dragend', function() {
        this.classList.remove('opacity-50');
    });
});
</script>
{% endblock %}
